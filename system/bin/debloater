#!/system/bin/sh
# Debloater - Oppo/ColorOS (CN) by Ox1d3x3
# Systemless debloater using pm disable/enable and list files on /sdcard/debloater

MODVERSION="0.4.0"
MODID="debloater_systemless_x1"
LIST_DIR="/sdcard/debloater"
LOGFILE="/data/adb/modules/$MODID/debloater_disable.log"

# ---------- helpers ----------

log() {
  TS="$(date '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo '0000-00-00 00:00:00')"
  echo "$TS  $*" >>"$LOGFILE"
}

detect_env() {
  DEVICE="$(getprop ro.product.model)"
  [ -z "$DEVICE" ] && DEVICE="$(getprop ro.product.product.model)"
  ANDROID_VER="$(getprop ro.build.version.release)"
  [ -z "$ANDROID_VER" ] && ANDROID_VER="$(getprop ro.system.build.version.release)"

  ROOTMGR="Unknown"
  if [ -d /data/adb/magisk ] || getprop persist.magisk.version >/dev/null 2>&1 || command -v magisk >/dev/null 2>&1; then
    ROOTMGR="Magisk"
  elif [ -d /data/adb/ksu ] || getprop persist.ksu.version >/dev/null 2>&1; then
    ROOTMGR="KernelSU"
  elif [ -d /data/adb/ap ] || getprop persist.apatch.version >/dev/null 2>&1; then
    ROOTMGR="APatch"
  fi
}

banner() {
  detect_env
  echo "===================================================="
  echo "        Debloater - Oppo/ColorOS (CN) by Ox1d3x3"
  echo "                 Version v$MODVERSION"
  echo "                 Github: @ox1d3x3"
  echo "                   __   __  __ "
  echo "                  \\ \\ / / /_ |"
  echo "                   \\ V /   | |"
  echo "                    > <    | |"
  echo "                   / . \\   | |"
  echo "                  /_/ \\_\\  |_|"
  echo "===================================================="
  echo " Device   : ${DEVICE:-unknown}"
  echo " Android  : ${ANDROID_VER:-unknown}"
  echo " Root     : ${ROOTMGR:-unknown}"
  echo " List dir : $LIST_DIR"
  echo " ModuleID : $MODID"
  echo ""
}

pause() {
  echo ""
  echo "Press Enter to continue..."
  read -r _
}

ensure_root() {
  id | grep -q "uid=0" || {
    echo "[X] This script must be run as root (su)."
    exit 1
  }
}

ensure_pm() {
  if ! command -v pm >/dev/null 2>&1; then
    echo "[X] 'pm' command not found. Are you on Android shell?"
    exit 1
  fi
}

# ---------- template bootstrap ----------

write_if_missing() {
  # $1 = path, $2 = content
  if [ ! -f "$1" ]; then
    echo "Creating template: $1"
    mkdir -p "$(dirname "$1")"
    cat <<EOF >"$1"
$2
EOF
  fi
}

init_debloat_dir() {
  echo "Init lists under $LIST_DIR ..."
  mkdir -p "$LIST_DIR"

  # Default disable profile
  write_if_missing "$LIST_DIR/disable.list" \
"# NAME: disable
# Default disable set for ColorOS 16 (CN).
# Focus: ads, store, CN media, and non-essential ecosystem services.

# Ads & store
com.oppo.ads
com.heytap.market

# CN browser
com.heytap.browser
com.coloros.browser

# CN media & extras
com.heytap.music
com.heytap.reader
com.heytap.pictorial
com.coloros.video
com.coloros.karaoke
andes.oplus.documentsreader

# Oppo ecosystem (consumer extras)
com.heytap.accessory
com.heytap.mydevices
com.heytap.vip
com.heytap.yoli
com.oppo.ctautoregist
com.oplus.contentportal
com.oplus.pay
com.oplus.omoji
com.oplus.ocar
com.heytap.opluscarlink
"

  # Extended CN ecosystem / Breeno profile
  write_if_missing "$LIST_DIR/cn_ecosystem.list" \
"# NAME: cn_ecosystem
# Extended CN ecosystem set for ColorOS 16 (CN).
# Includes browser, AI/Breeno stack, media, and ecosystem services.

# Ads & store
com.oppo.ads
com.heytap.market

# CN browser
com.heytap.browser
com.coloros.browser

# Breeno / AI stack
com.heytap.speechassist
com.oplus.ovoicemanager
com.oplus.ovoicemanager.wakeup
com.oplus.aicall
com.oplus.aiwriter
com.oplus.aiwidgets
com.oplus.aiunit
com.oplus.obrain
com.oplus.deepthinker
com.oplus.metis
com.oplus.matrix
com.oplus.atlas

# CN media & extras
com.heytap.music
com.heytap.reader
com.heytap.pictorial
com.coloros.video
com.coloros.karaoke
andes.oplus.documentsreader

# Oppo ecosystem
com.heytap.accessory
com.heytap.mydevices
com.heytap.vip
com.heytap.yoli
com.oppo.ctautoregist
com.oplus.contentportal
com.oplus.pay
com.oplus.omoji
com.oplus.ocar
com.heytap.opluscarlink
"

  # Breeno minimal only
  write_if_missing "$LIST_DIR/breeno_minimal.list" \
"# NAME: breeno_minimal
# Minimal Breeno/AI stack disable for ColorOS 16 (CN).
# Focused on assistant/AI only. Does NOT include browser/store/media.

com.heytap.speechassist
com.oplus.ovoicemanager
com.oplus.ovoicemanager.wakeup
com.oplus.aicall
com.oplus.aiwriter
com.oplus.aiwidgets
com.oplus.aiunit
com.oplus.obrain
com.oplus.deepthinker
com.oplus.metis
com.oplus.matrix
com.oplus.atlas
"

  # Reference list
  write_if_missing "$LIST_DIR/coloros16_reference.list" \
"# NAME: coloros16_reference
# Reference list for common ColorOS 16 (CN) bloat.
# This file is NOT used automatically. Copy what you want into disable.list.

# Ads & store
com.oppo.ads
com.heytap.market

# CN browser
com.heytap.browser
com.coloros.browser

# Breeno / AI stack
com.heytap.speechassist
com.oplus.ovoicemanager
com.oplus.ovoicemanager.wakeup
com.oplus.aicall
com.oplus.aiwriter
com.oplus.aiwidgets
com.oplus.aiunit
com.oplus.obrain
com.oplus.deepthinker
com.oplus.metis
com.oplus.matrix
com.oplus.atlas

# CN media & extras
com.heytap.music
com.heytap.reader
com.heytap.pictorial
com.coloros.video
com.coloros.karaoke
andes.oplus.documentsreader

# Oppo ecosystem
com.heytap.accessory
com.heytap.mydevices
com.heytap.vip
com.heytap.yoli
com.oppo.ctautoregist
com.oplus.contentportal
com.oplus.pay
com.oplus.omoji
com.oplus.ocar
com.heytap.opluscarlink
"

  # Enabled list (populated by full restore)
  write_if_missing "$LIST_DIR/enabled.list" \
"# NAME: enabled
# This file is populated by the Debloater full-restore option.
# It contains packages that were re-enabled by the module.
"
}

# ---------- core actions ----------

apply_set_disable() {
  file="$1"
  echo ""
  echo "Mode: disable (pm disable-user --user 0)"
  echo ""

  total=0
  disabled=0
  failed=0

  while IFS= read -r line || [ -n "$line" ]; do
    pkg="$(echo "$line" | tr -d '\r' | sed 's/#.*$//' | sed 's/^ *//;s/ *$//')"
    [ -z "$pkg" ] && continue

    total=$((total + 1))

    if pm disable-user --user 0 "$pkg" >/dev/null 2>&1; then
      echo " - disabled: $pkg"
      log "DISABLE_OK $pkg"
      disabled=$((disabled + 1))
    else
      echo " - failed (not installed or cannot be disabled): $pkg"
      log "DISABLE_FAIL $pkg"
      failed=$((failed + 1))
    fi
  done < "$file"

  echo ""
  echo "Summary:"
  echo "  entries : $total"
  echo "  disabled: $disabled"
  echo "  failed  : $failed"
}

apply_set_enable() {
  file="$1"
  echo ""
  echo "Mode: restore (pm enable --user 0)"
  echo ""

  total=0
  enabled=0
  failed=0

  while IFS= read -r line || [ -n "$line" ]; do
    pkg="$(echo "$line" | tr -d '\r' | sed 's/#.*$//' | sed 's/^ *//;s/ *$//')"
    [ -z "$pkg" ] && continue

    total=$((total + 1))

    if pm enable --user 0 "$pkg" >/dev/null 2>&1; then
      echo " - enabled: $pkg"
      log "ENABLE_OK $pkg"
      enabled=$((enabled + 1))
    else
      echo " - failed (not installed or cannot be enabled): $pkg"
      log "ENABLE_FAIL $pkg"
      failed=$((failed + 1))
    fi
  done < "$file"

  echo ""
  echo "Summary:"
  echo "  entries : $total"
  echo "  enabled : $enabled"
  echo "  failed  : $failed"
}

restore_full_from_lists() {
  echo ""
  echo "Full restore from templates"
  echo "---------------------------"

  if [ ! -d "$LIST_DIR" ]; then
    echo "[X] List directory not found: $LIST_DIR"
    echo "    Run debloater once to initialise templates."
    return 1
  fi

  tmp_union="/data/local/tmp/debloater_restore_union.$$"
  : >"$tmp_union"

  # Union of default + CN ecosystem + Breeno minimal
  for name in disable cn_ecosystem breeno_minimal; do
    f="$LIST_DIR/$name.list"
    if [ -f "$f" ]; then
      grep -v '^[[:space:]]*#' "$f" \
        | sed 's/\r$//' \
        | sed 's/^ *//;s/ *$//' \
        | sed '/^$/d' >>"$tmp_union"
    fi
  done

  if [ ! -s "$tmp_union" ]; then
    echo "[i] No entries found in disable/cn_ecosystem/breeno_minimal lists."
    echo "    Nothing to restore."
    rm -f "$tmp_union"
    return 0
  fi

  PKGS="$(sort -u "$tmp_union")"
  rm -f "$tmp_union"

  enabled_list="$LIST_DIR/enabled.list"
  if ! grep -q "NAME: enabled" "$enabled_list" 2>/dev/null; then
    echo "# NAME: enabled" >"$enabled_list"
    echo "# Auto-generated by full restore on $(date)" >>"$enabled_list"
  else
    echo "# Updated by full restore on $(date)" >>"$enabled_list"
  fi

  total=0
  enabled=0
  failed=0

  echo ""
  echo "Restoring packages from debloat templates..."
  echo ""

  for pkg in $PKGS; do
    total=$((total + 1))
    if pm enable --user 0 "$pkg" >/dev/null 2>&1; then
      echo " - enabled: $pkg"
      echo "$pkg" >>"$enabled_list"
      log "ENABLE_FULL_OK $pkg"
      enabled=$((enabled + 1))
    else
      echo " - failed: $pkg"
      log "ENABLE_FULL_FAIL $pkg"
      failed=$((failed + 1))
    fi
  done

  echo ""
  echo "Summary:"
  echo "  from lists: $total"
  echo "  enabled   : $enabled"
  echo "  failed    : $failed"
  echo ""
  echo "Details of restored packages recorded in:"
  echo "  $enabled_list"
}

# ---------- info / listing ----------

list_all_apps() {
  echo ""
  echo "Installed packages (pm list packages)"
  echo "-------------------------------------"
  pm list packages | sed 's/^package://'
}

list_disabled_apps() {
  echo ""
  echo "Disabled packages (pm list packages -d)"
  echo "--------------------------------------"
  if pm list packages -d >/dev/null 2>&1; then
    pm list packages -d | sed 's/^package://'
  else
    echo "[X] 'pm list packages -d' not supported on this build."
  fi
}

# ---------- Breeno hard kill ----------

force_breeno_disable() {
  echo ""
  echo "Force Breeno/AI disable"
  echo "-----------------------"

  BRENO_PKGS="
com.heytap.speechassist
com.oplus.ovoicemanager
com.oplus.ovoicemanager.wakeup
com.oplus.aicall
com.oplus.aiwriter
com.oplus.aiwidgets
com.oplus.aiunit
com.oplus.obrain
com.oplus.deepthinker
com.oplus.metis
com.oplus.matrix
com.oplus.atlas
"

  total=0
  ok=0
  fail=0

  for pkg in $BRENO_PKGS; do
    [ -z "$pkg" ] && continue
    total=$((total + 1))
    echo ">>> $pkg"

    if pm disable-user --user 0 "$pkg" >/dev/null 2>&1; then
      echo " - pm disable-user OK"
      log "BREENO_FORCE_DISABLE_USER_OK $pkg"
    else
      echo " - pm disable-user failed"
      log "BREENO_FORCE_DISABLE_USER_FAIL $pkg"
    fi

    if pm disable "$pkg" >/dev/null 2>&1; then
      echo " - pm disable OK"
      log "BREENO_FORCE_DISABLE_OK $pkg"
    fi

    if command -v cmd >/dev/null 2>&1; then
      if cmd package suspend --user 0 "$pkg" >/dev/null 2>&1; then
        echo " - cmd package suspend OK"
        log "BREENO_FORCE_SUSPEND_OK $pkg"
        ok=$((ok + 1))
        continue
      fi
    fi

    if pm list packages -d | grep -q "$pkg"; then
      ok=$((ok + 1))
    else
      fail=$((fail + 1))
    fi
  done

  echo ""
  echo "Force Breeno summary:"
  echo "  targets: $total"
  echo "  likely disabled/suspended: $ok"
  echo "  unknown/fail: $fail"
  echo ""
  echo "Note: Some ROMs may re-enable parts of Breeno after OTA or reboot."
  echo "      Re-run this option if you see it come back."
}

# ---------- GitHub update check ----------

check_updates() {
  echo ""
  echo "Update check (GitHub releases)"
  echo "------------------------------"
  REPO="ox1d3x3/op-debloat"
  API_URL="https://api.github.com/repos/$REPO/releases/latest"

  if command -v curl >/dev/null 2>&1; then
    RESP="$(curl -sL "$API_URL")"
  elif command -v wget >/dev/null 2>&1; then
    RESP="$(wget -qO- "$API_URL")"
  else
    echo "[X] curl/wget not available. Cannot check for updates."
    return 1
  fi

  if [ -z "$RESP" ]; then
    echo "[X] Empty response from GitHub. Network or API issue."
    return 1
  fi

  REMOTE_TAG="$(echo "$RESP" | sed -n 's/ *\"tag_name\": *\"\\(.*\\)\",/\\1/p' | head -n 1)"
  if [ -z "$REMOTE_TAG" ]; then
    echo "[X] Could not parse remote version (tag_name)."
    return 1
  fi

  REMOTE_VER="${REMOTE_TAG#v}"
  REMOTE_VER="${REMOTE_VER#V}"
  LOCAL_VER="${MODVERSION#v}"

  echo " Local version : $LOCAL_VER"
  echo " Remote version: $REMOTE_VER (tag: $REMOTE_TAG)"

  ver_to_ints() {
    v="$1"
    IFS='.' read -r a b c <<EOF
$v
EOF
    [ -z "$a" ] && a=0
    [ -z "$b" ] && b=0
    [ -z "$c" ] && c=0
    echo "$a $b $c"
  }

  set -- $(ver_to_ints "$LOCAL_VER")
  LA=$1; LB=$2; LC=$3
  set -- $(ver_to_ints "$REMOTE_VER")
  RA=$1; RB=$2; RC=$3

  if [ "$RA" -gt "$LA" ] || { [ "$RA" -eq "$LA" ] && [ "$RB" -gt "$LB" ]; } || { [ "$RA" -eq "$LA" ] && [ "$RB" -eq "$LB" ] && [ "$RC" -gt "$LC" ]; }; then
    echo ""
    echo "Update available:"
    echo " - Installed: $LOCAL_VER"
    echo " - Latest   : $REMOTE_VER"
    echo ""
    echo "Download from:"
    echo " https://github.com/$REPO/releases/latest"
  else
    echo ""
    echo "No update available. You are on the latest known version."
  fi
}

# ---------- profile selection ----------

select_set() {
  echo ""
  echo "Available debloat profiles in $LIST_DIR:"
  echo "----------------------------------------"

  i=0
  choices=""
  for f in "$LIST_DIR"/*.list; do
    [ -f "$f" ] || continue
    i=$((i + 1))
    base="$(basename "$f")"
    echo "  $i) $base"
    choices="$choices $f"
  done

  if [ "$i" -eq 0 ]; then
    echo "[X] No .list files found in $LIST_DIR."
    echo "    Edit or create lists there, then try again."
    return 1
  fi

  echo ""
  printf "Select profile [1-%d]: " "$i"
  read -r sel

  n=0
  for f in $choices; do
    n=$((n + 1))
    if [ "$n" = "$sel" ]; then
      SELECTED_SET="$f"
      echo "Using: $SELECTED_SET"
      return 0
    fi
  done

  echo "[X] Invalid selection."
  return 1
}

# ---------- main menu ----------

main_menu() {
  while true; do
    echo ""
    echo "Main menu"
    echo "---------"
    echo "  1) Disable packages (debloat set)"
    echo "  2) Enable/restore packages (debloat set)"
    echo "  3) Full restore (from disable/cn_ecosystem/breeno_minimal)"
    echo "  4) List all packages"
    echo "  5) List disabled packages"
    echo "  6) Force Breeno disable"
    echo "  7) Check for updates (GitHub)"
    echo "  0) Exit"
    echo ""
    printf "Choice: "
    read -r choice

    case "$choice" in
      1)
        if select_set; then
          apply_set_disable "$SELECTED_SET"
        fi
        pause
        ;;
      2)
        if select_set; then
          apply_set_enable "$SELECTED_SET"
        fi
        pause
        ;;
      3)
        restore_full_from_lists
        pause
        ;;
      4)
        list_all_apps
        pause
        ;;
      5)
        list_disabled_apps
        pause
        ;;
      6)
        force_breeno_disable
        pause
        ;;
      7)
        check_updates
        pause
        ;;
      0)
        echo "Exit."
        break
        ;;
      *)
        echo "[X] Invalid option."
        pause
        ;;
    esac
  done
}

# ---------- entrypoint ----------

ensure_root
ensure_pm
banner
init_debloat_dir
main_menu
